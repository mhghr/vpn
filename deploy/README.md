## نصب خودکار روی سرور (حالت Webhook)

در حالت عادی پروژه روی لوکال با `polling` اجرا می‌شود.

اسکریپت `deploy/install_webhook.sh` روی سرور:
- پکیج‌های لازم را نصب می‌کند (Python/PostgreSQL/Nginx/Certbot)
- وابستگی‌های پایتون را به‌صورت نسخه‌پین‌شده و با `pip check` نصب/اعتبارسنجی می‌کند تا ریسک ناسازگاری نسخه‌ها کم شود
- دیتابیس و یوزر PostgreSQL را می‌سازد
- فایل `.env` را فقط با مقادیر ضروری اجرای ربات/وبهوک/دیتابیس می‌سازد (توکن ربات، ادمین، کانال، تنظیمات DB)
- فایل اجرای بات را از حالت polling به webhook تغییر می‌دهد (`main.py`)
- سرویس systemd می‌سازد و Nginx+SSL را تنظیم می‌کند

> نکته: اطلاعات میکروتیک/سرورها عمداً داخل اسکریپت پرسیده نمی‌شود و باید بعد از بالا آمدن ربات از پنل ادمین داخل خود بات ثبت شوند.

> نکته: اطلاعاتی مثل کارت بانکی در این اسکریپت پرسیده نمی‌شود.

### اجرا

```bash
sudo bash deploy/install_webhook.sh
```

پس از اجرا، ربات و دیتابیس بدون نیاز به تغییر دستی اضافه بالا می‌آیند.
همچنین فایل `bot/requirements.lock.txt` برای عیب‌یابی و تکرارپذیری نسخه‌ها ساخته می‌شود.

## انتقال کاربران از CSV قدیمی

اگر از دیتابیس قبلی خروجی CSV دارید (ستون **B** = `telegram_id`، ستون **C** = `first_name`، ستون **D** = `username`)، می‌توانید با اسکریپت زیر کاربران را وارد دیتابیس جدید کنید:

```bash
cd bot
python import_legacy_users.py --csv users.csv
```

برای تست بدون ذخیره در دیتابیس:

```bash
cd bot
python import_legacy_users.py --csv users.csv --dry-run
```


## آپدیت امن از گیت (بعد از تغییر کد پروژه)

برای آپدیت ربات روی سرور (حتی اگر فایل‌ها کم/زیاد شده باشند) از اسکریپت زیر استفاده کنید:

```bash
sudo bash deploy/update_from_git.sh
```

اگر خواستید از برنچ مشخص آپدیت کنید:

```bash
sudo bash deploy/update_from_git.sh main
```

این اسکریپت:
- آخرین تغییرات را از `origin` می‌گیرد و روی همان برنچ/برنچ دلخواه سینک می‌کند
- فایل `.env` سرور را نگه می‌دارد تا تنظیمات شما از بین نرود
- `main.py` را دوباره روی حالت webhook ست می‌کند
- وابستگی‌های پایتون را نصب/اعتبارسنجی می‌کند
- سرویس systemd ربات را ری‌استارت می‌کند


### نکته مهم درباره دیتابیس در آپدیت

اسکریپت `update_from_git.sh` دیتابیس را حذف نمی‌کند و دستور `drop/truncate` اجرا نمی‌کند؛
فقط کد را آپدیت و سرویس را ری‌استارت می‌کند.

در اولین اجرای بات بعد از آپدیت، `init_db()` فقط مایگریشن‌های غیرتخریبی (مثل `ADD COLUMN IF NOT EXISTS`) را اعمال می‌کند.

با این حال برای امنیت بیشتر، قبل از هر آپدیت یک بکاپ بگیرید:

```bash
pg_dump -Fc -d "<DATABASE_URL>" -f /root/myvpn_$(date +%F_%H-%M).dump
```

در صورت نیاز به بازیابی:

```bash
pg_restore -d "<DATABASE_URL>" /root/myvpn_YYYY-MM-DD_HH-MM.dump
```
